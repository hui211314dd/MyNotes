# 指令

trace.start frame,cpu,gpu | trace.stop 开始停止数据追踪

stat unit 命令显示项目的 Frame 、 Game 、 Draw 、 GPU 、 RHIT 和 DynRes 线程的性能信息

stat game能查阅游戏逻辑在特定情况下的每帧更新耗时

dumpticks命令它能列出正在更新的所有Actor以及它们的总数

stat RHI，triangles drawn就是面数

r.VSync 0  -  垂直同步（0 关闭，1 打开）

每个draw call都有固定的开销，draw call越多，你来回绘制所耗费的时间就会呈线性增加，情况会越来越糟糕。可以使用stat scenerendering 命令随时查看场景绘制

要想找出这个阶段中的问题，一个简单的方法就是，关掉各个功能特性，关掉Static mesh静态网格体，关掉Skeletal骨骼网格体，关掉Particles粒子效果。ShowFlag命令对此非常有用

```C++
ShowFlag.StaticMeshes
ShowFlag.SkeletalMeshes
ShowFlag.Particles
ShowFlag.Lighting
ShowFlag.Translucency
ShowFlag.ReflectionEnvironment
ShowFlag.InstancedStaticMeshes
```

GPU Profiling，不仅可以在编辑器中运行它，还能在开发版本李运行ProfileGPU会生成一个文件。所有发送给GPU的命令，它的时间戳都会显示在其中，让你能轻易的检查特定帧的每一步渲染过程，它会按照时间顺序排列命令。并且显示相关命令的处理时间，以及那一帧的耗时，也许你就能找到场景中某个特定部分的问题原因。它也可以通过快捷键Ctrl+Shift+，来使用。这很简单，能帮你找出游戏中的后期处理反射或者体积雾是否会导致问题

ShowFlag.QuadOverdraw
Quad Overdraw四边形过度绘制对于美术师来说，解决过渡着色的一大方法就是在检查创作内容时，使用所谓的“Quad Overdraw”四边形过度绘制模式，这个模式还能在很多其他平台上运行。它基本会显示所有可以用LOD简化的区域，以及需要用LOD大量优化的区域，它是一个渐变的形式从蓝到白，越接近白色情况就越糟糕

ShowFlag.ShaderComplexity
Shader Complexity 着色器复杂度，也很好用。它能将你在屏幕上绘制的每个像素的着色器的复杂度以视觉化形式呈现出来，它还能视觉化呈现潜在的过度绘制问题。过度绘制不仅有可能在你处理屏幕上众多顶点时发生，也有可能在你使用很多alpha通道时，在你需要处理alpha通道的各个图层时发生。引擎并不知道哪个在哪个的下面，所以引擎会处理所有的表面，才能绘制像素的最终色彩。所以着色器复杂度可以用来显示着色器的开销，要尽量避免红色和白色斑块的出现，因为它们会导致性能问题

ShowFlag.LightComplexity
关于光照复杂度，通用的建议是要尽量减少动态光源的数量，它们是实时渲染的，每帧都是。GPU需要做大量处理和运算，才能得出像素在光照影响下得最终色彩。所以要尽量减少动态光源的数量，如果你真的要用到它，你应该尽量缩小它的范围。这样它只会照亮对你比较重要的区域也就是关卡的某一部分，你还可以减少动态光源所影响的对象数量。你可以让对象和光源使用light channel光照分层功能，阴影投射的开销也很大。所以如果你有动态光源，但又不是真的需要投射阴影，那就关掉它


## 内存

memreport -full

stat memory

## UI

stat slate

Slate.Showbatching 0/1：关闭或打开批次颜色，根据颜色看当前批次

Slate.showOverDraw 0/1：关闭或打开OverDraw颜色，越白OverDraw越厉害

Slate.ShowClipping 0/1： 显示裁剪

Slate.InvalidationDebugging

白线框：Widget has a tick function. 动画或者需要tick的节点
绿线框：Widget has an active timer that needs to update 当前Widget有激活中的Timer需要更
蓝线框：Needs repaint because the widget is volatile。每帧tick
黄色框: Widget was invalidated.当前Widget需要重绘,. 黄色到红色渐变，越接近红色，越是最近发生重绘
红线框：说明这个Widget一直被刷新

## 参考资料

[UE4 Unreal Insights基本使用](https://zhuanlan.zhihu.com/p/511148107)
[UE4 UI性能优化](https://zhuanlan.zhihu.com/p/532437923)
[UE4渲染-slate合批流程](https://zhuanlan.zhihu.com/p/529040584)
[UE4渲染-slate渲染流程](https://zhuanlan.zhihu.com/p/528826488)
[资产优化](https://zhuanlan.zhihu.com/p/622541522)
[性能工具-内存篇](https://zhuanlan.zhihu.com/p/452214767)